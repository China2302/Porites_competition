---
title: "Polyp Activity. Plots and Final Statistics"
author: "Rhondda Jones, Natalia Andrade and Ira Cooke"
date: "29/08/2017"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ordinal)
```

```{r}
polyp_act<-read_csv("raw_data/Porites_polypact.csv") %>% 
  mutate_if(is.numeric, as.factor) 


polyp_act_long <- polyp_act %>% 
  pivot_longer(cols = starts_with("DAY"), names_to="Time", values_to="Activity") %>% 
  mutate(Time=as.integer(str_match(Time, pattern = "DAY([0-9]+)")[,2])) %>% 
  mutate(Activity=factor(Activity, levels = c("C", "P","O"), ordered=TRUE)) %>% 
  mutate(TANK=as.factor(TANK)) %>% 
  mutate(TimeCat = cut(Time, breaks=c(0,14.1,19.1,24.1,29.1,34.1,39.1,44.1,49.1,54.1,60))) %>% 
  mutate(TimeCat = factor(TimeCat,
         labels=c("<15","15-20","20-25","25-30","30-35","35-40","40-45","45-50","50-55","55-60")))

```

This is a ggplot equivalent of of the Mosaicplots used in data exploration. This shows data aggregated across nubbins and tanks which does hide some important variation that is hard to capture graphically (see stats).  Overall however there are two clear trends;

1. The treated colonies are more likely to be partial or closed than controls
2. Colonies seemed to be more likely to be partial or closed at the start of the trial and gradually converted to open as the trial progressed.

```{r}
library(ggpubr)
polyp_act_long %>% na.omit() %>% 
  group_by(HARD,TREAT,TimeCat) %>%   
  mutate(tankcount=length(unique(TANK))) %>% 
  group_by(HARD,TREAT,TimeCat,Activity) %>% 
  mutate(catcount=n()) %>% 
  ungroup() %>% 
  mutate(TREAT = ifelse(TREAT=="Yes","Competition","Control")) %>% 
  mutate(TimeCat = as.factor(TimeCat)) %>% 
  ggplot(aes(x=TimeCat)) + 
  geom_col(aes(fill=Activity,y=catcount), position = "fill") +
  geom_text(aes(y=0.1,label=tankcount), fill = "transparent",size=2, color="grey40") +
  geom_vline(xintercept=4.5,color="blue") +
  facet_grid(HARD~TREAT) + 
  theme_pubclean() +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Days Since Start") + ylab("Proportion of Nubbins")
```


```{r, echo=FALSE, eval=FALSE}
ggsave("figures/polyp_activity.png",width = 12,height = 8)
```


Based on extensive model selection analysis (see [03_polyp_activity_exploration.md](03_polyp_activity_exploration.md)) a generalised cumulative mixed effects model was chosen to fit the polyp activity data. 


```{r}
fm3d =clmm2(location=Activity ~ TimeCat+TREAT+HARD, random=TANK, Hess=TRUE,  data=polyp_act_long)
summary(fm3d)
```


Let's consider whether there are interesting patterns of polyp activity in relation to the PCA and Heatmap groupings.  At least on the surface it looks as though both down and up groupings (Red and Blue on the heatmap in 02_deseq) show more closed or partial activity early in the experiment than those in the "neutral" group.



```{r}
hm_col_groups <- list(down = c("PdLb","PfLd","PfLa"), neutral = c("PdC","PdLc","PfLe","PfLb","PfC"), up = c("PdLe","PdLa","PfLc"))

polyp_act_long_colgrp <- polyp_act_long %>% 
  unite("HardCoralControl",HARD,SOFT, remove = FALSE, sep = "") %>% 
  mutate(colgroup = "neutral") %>% 
  mutate(colgroup = ifelse(HardCoralControl %in% hm_col_groups$up,"up","neutral")) %>% 
  mutate(colgroup = ifelse(HardCoralControl %in% hm_col_groups$down,"down",colgroup))



polyp_act_long_colgrp %>% na.omit() %>% 
  group_by(colgroup,TimeCat) %>%   
  mutate(tankcount=length(unique(TANK))) %>% 
  group_by(colgroup,TimeCat,Activity) %>% 
  mutate(catcount=n()) %>% 
  ungroup() %>% 
  mutate(TimeCat = as.factor(TimeCat)) %>% 
  ggplot(aes(x=TimeCat)) + 
  geom_col(aes(fill=Activity,y=catcount), position = "fill") +
  geom_text(aes(y=0.1,label=tankcount), fill = "transparent",size=2, color="grey40") +
  geom_vline(xintercept=4.5,color="blue") +
  facet_grid(~colgroup) + 
  theme_pubclean() +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Days Since Start") + ylab("Proportion of Nubbins")


```

